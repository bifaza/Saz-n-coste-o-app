<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas & Gastos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f3; padding: 15px; max-width: 800px; margin: auto; padding-bottom: 100px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h4 { text-align: center; color: #7f8c8d; margin-top: 0; }
        
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .titulo-seccion { font-size: 1.2em; font-weight: bold; color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Botones y Contadores */
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: 600; font-size: 1em; }
        .item-price { font-size: 0.85em; color: #7f8c8d; }
        
        .btn-group { display: flex; gap: 8px; align-items: center; }
        button { border: none; border-radius: 8px; cursor: pointer; color: white; touch-action: manipulation; font-weight: bold; }
        .btn-mas { background-color: #27ae60; padding: 5px 12px; font-size: 1.2em; }
        .btn-menos { background-color: #e74c3c; padding: 5px 12px; font-size: 1.2em; }
        .contador { font-size: 1.2em; font-weight: bold; min-width: 30px; text-align: center; }

        /* SecciÃ³n Gastos */
        .gastos-form { display: flex; gap: 5px; margin-bottom: 10px; }
        .input-gasto { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; }
        .btn-gasto { background-color: #d35400; padding: 10px; width: 100%; }
        .lista-gastos { list-style: none; padding: 0; font-size: 0.9em; color: #c0392b; }
        .lista-gastos li { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; }

        /* BotÃ³n crear producto */
        .btn-crear { background-color: #3498db; padding: 8px 15px; font-size: 0.9em; width: 100%; margin-top: 10px; }
        
        /* Totales y GrÃ¡fica */
        .total-box { background: #2c3e50; color: white; padding: 15px; border-radius: 12px 12px 0 0; position: fixed; bottom: 0; left: 0; right: 0; max-width: 800px; margin: auto; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .resumen-flex { display: flex; justify-content: space-between; align-items: center; }
        .balance-grande { font-size: 1.8em; font-weight: bold; }
        .btn-cerrar { background-color: #c0392b; font-size: 0.8em; padding: 8px; margin-top: 10px; width: 100%; }
        
        .chart-container { position: relative; height: 200px; width: 100%; }

        /* Historial */
        .historial-item { background: #f9f9f9; padding: 10px; border-left: 5px solid #3498db; margin-bottom: 5px; }
        .fecha { font-weight: bold; color: #2980b9; }

        /* PestaÃ±as */
        .tabs { display: flex; margin-bottom: 15px; gap: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: #ddd; color: #333; text-align: center; border-radius: 8px; }
        .tab-btn.active { background: #2c3e50; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>ðŸ“Š Control Negocio</h1>
    <h4 id="estado-conexion">Conectando...</h4>

    <div class="tabs">
        <div class="tab-btn active" onclick="mostrarTab('tab-ventas')">Ventas</div>
        <div class="tab-btn" onclick="mostrarTab('tab-gastos')">Gastos</div>
        <div class="tab-btn" onclick="mostrarTab('tab-historial')">Historial</div>
    </div>

    <div id="tab-ventas">
        
        <div class="card">
            <div class="titulo-seccion">ðŸ¥˜ Platos Principales</div>
            <div id="container-platos"></div> </div>

        <div class="card">
            <div class="titulo-seccion">ðŸ¥¤ Bebidas y Jugos</div>
            <div id="container-bebidas"></div> </div>

        <div class="card">
            <div class="titulo-seccion">
                âœ¨ Extras / Nuevos
                <button style="background:transparent; color:#3498db; font-size:0.8em;" onclick="toggleCrear()">+ Nuevo</button>
            </div>
            
            <div id="form-crear-prod" style="display:none; background:#f0f8ff; padding:10px; margin-bottom:10px; border-radius:5px;">
                <input type="text" id="nuevo-nombre" placeholder="Nombre (ej: Postre)" class="input-gasto" style="margin-bottom:5px;">
                <input type="number" id="nuevo-precio" placeholder="Precio (ej: 2.50)" class="input-gasto" style="margin-bottom:5px;">
                <button class="btn-crear" onclick="crearProducto()">Guardar Producto</button>
            </div>

            <div id="container-extras"></div>
        </div>
    </div>

    <div id="tab-gastos" class="hidden">
        <div class="card">
            <div class="titulo-seccion">ðŸ’¸ Registro de Gastos/Salidas</div>
            <div class="gastos-form">
                <input type="text" id="gasto-nombre" placeholder="DescripciÃ³n (ej: Hielo)" class="input-gasto" style="flex:2;">
                <input type="number" id="gasto-monto" placeholder="$" class="input-gasto" style="flex:1;">
            </div>
            <button class="btn-gasto" onclick="agregarGasto()">Registrar Gasto (Salida)</button>
            
            <h3 style="margin-top:20px;">Lista del dÃ­a:</h3>
            <ul id="lista-gastos-ul" class="lista-gastos"></ul>
        </div>
    </div>

    <div id="tab-historial" class="hidden">
        <div class="card">
            <div class="titulo-seccion">ðŸ“… Cierres de Caja Anteriores</div>
            <div id="container-historial">Cargando...</div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 120px;">
        <div class="titulo-seccion">ðŸ“ˆ GrÃ¡fica del DÃ­a</div>
        <div class="chart-container">
            <canvas id="miGrafica"></canvas>
        </div>
    </div>

    <div class="total-box">
        <div class="resumen-flex">
            <div>
                <small>Ventas: <span id="lbl-ventas" style="color:#2ecc71">$0.00</span></small><br>
                <small>Gastos: <span id="lbl-gastos" style="color:#e74c3c">$0.00</span></small>
            </div>
            <div class="balance-grande" id="lbl-balance">$0.00</div>
        </div>
        <button class="btn-cerrar" onclick="cerrarCaja()">ðŸ”’ CERRAR CAJA (Guardar y Reiniciar)</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- â¬‡ï¸ PEGA AQUÃ TU CONFIGURACIÃ“N DE FIREBASE â¬‡ï¸ ---
       const firebaseConfig = {
  apiKey: "AIzaSyAIPTdjtcrpk1tziuPq0yOZIXfHWnugxcQ",
  authDomain: "sazoncosteno-3d6e2.firebaseapp.com",
  projectId: "sazoncosteno-3d6e2",
  storageBucket: "sazoncosteno-3d6e2.firebasestorage.app",
  messagingSenderId: "440978122168",
  appId: "1:440978122168:web:3ad5bf278767ec00aa5b4d",
  measurementId: "G-H34849VKPN"
};
        // ----------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // CONFIGURACIÃ“N INICIAL DE PRODUCTOS FIJOS
        const menuFijo = [
            { id: 'picada_completa_mesa', nombre: 'Picada (Mesa)', precio: 4.00, cat: 'platos' },
            { id: 'picada_completa_llevar', nombre: 'Picada (Llevar)', precio: 4.25, cat: 'platos' },
            { id: 'picada_media_mesa', nombre: 'Media Picada (Mesa)', precio: 3.00, cat: 'platos' },
            { id: 'picada_media_llevar', nombre: 'Media Picada (Llevar)', precio: 3.25, cat: 'platos' },
            { id: 'caldo_completo_mesa', nombre: 'Caldo (Mesa)', precio: 4.00, cat: 'platos' },
            { id: 'caldo_completo_llevar', nombre: 'Caldo (Llevar)', precio: 4.25, cat: 'platos' },
            { id: 'caldo_medio_mesa', nombre: 'Medio Caldo (Mesa)', precio: 3.00, cat: 'platos' },
            { id: 'caldo_medio_llevar', nombre: 'Medio Caldo (Llevar)', precio: 3.25, cat: 'platos' },
            { id: 'limonada_vaso', nombre: 'Jugo Vaso', precio: 0.50, cat: 'bebidas' },
            { id: 'limonada_jarra', nombre: 'Jugo Jarra', precio: 1.50, cat: 'bebidas' },
            { id: 'sprite', nombre: 'Sprite', precio: 0.75, cat: 'bebidas' },
            { id: 'fiora', nombre: 'Fiora', precio: 0.75, cat: 'bebidas' },
            { id: 'inka', nombre: 'Inka', precio: 0.75, cat: 'bebidas' },
            { id: 'coca', nombre: 'Coca Cola', precio: 0.75, cat: 'bebidas' },
            { id: 'fanta', nombre: 'Fanta', precio: 0.75, cat: 'bebidas' }
        ];

        // Variables globales
        let datosDia = { ventas: {}, gastos: {} };
        let productosExtras = {};
        let myChart = null;

        // 1. INICIALIZAR PANTALLA
        function renderMenuFijo() {
            const cPlatos = document.getElementById('container-platos');
            const cBebidas = document.getElementById('container-bebidas');
            
            menuFijo.forEach(item => {
                const html = `
                <div class="item-row">
                    <div class="item-info">
                        <span class="item-name">${item.nombre}</span>
                        <span class="item-price">$${item.precio.toFixed(2)}</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-menos" onclick="window.cambiarCant('${item.id}', -1)">-</button>
                        <span id="cant_${item.id}" class="contador">0</span>
                        <button class="btn-mas" onclick="window.cambiarCant('${item.id}', 1)">+</button>
                    </div>
                </div>`;
                
                if(item.cat === 'platos') cPlatos.innerHTML += html;
                else cBebidas.innerHTML += html;
            });
        }
        renderMenuFijo();

        // 2. ESCUCHAR PRODUCTOS EXTRAS (DinÃ¡micos)
        onValue(ref(db, 'config_menu_extras'), (snapshot) => {
            const data = snapshot.val() || {};
            productosExtras = data;
            const container = document.getElementById('container-extras');
            container.innerHTML = '';

            Object.keys(data).forEach(key => {
                const item = data[key];
                const html = `
                <div class="item-row" style="background:#fdfefe; padding:5px;">
                    <div class="item-info">
                        <span class="item-name">${item.nombre}</span>
                        <span class="item-price">$${item.precio}</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-menos" onclick="window.cambiarCant('${key}', -1, true)">-</button>
                        <span id="cant_${key}" class="contador">0</span>
                        <button class="btn-mas" onclick="window.cambiarCant('${key}', 1, true)">+</button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
            actualizarNumerosUI(); // Refrescar por si ya habia ventas cargadas
        });

        // 3. ESCUCHAR VENTAS Y GASTOS DEL DÃA (Tiempo Real)
        onValue(ref(db, 'dia_actual'), (snapshot) => {
            document.getElementById('estado-conexion').innerText = "ðŸŸ¢ Conectado";
            const data = snapshot.val();
            
            datosDia.ventas = (data && data.ventas) ? data.ventas : {};
            datosDia.gastos = (data && data.gastos) ? data.gastos : {};
            
            actualizarNumerosUI();
            renderGastos();
        });

        // 4. FUNCIONES DE ACCIÃ“N
        window.cambiarCant = (id, delta, esExtra = false) => {
            const current = (datosDia.ventas[id] || 0);
            const nuevo = current + delta;
            if(nuevo < 0) return;

            const updates = {};
            updates['dia_actual/ventas/' + id] = nuevo;
            update(ref(db), updates);
        };

        window.toggleCrear = () => {
            const el = document.getElementById('form-crear-prod');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        window.crearProducto = () => {
            const nombre = document.getElementById('nuevo-nombre').value;
            const precio = parseFloat(document.getElementById('nuevo-precio').value);
            
            if(nombre && precio) {
                const newRef = push(ref(db, 'config_menu_extras'));
                set(newRef, { nombre: nombre, precio: precio });
                document.getElementById('nuevo-nombre').value = '';
                document.getElementById('nuevo-precio').value = '';
                alert("Producto agregado. Ahora todos pueden venderlo.");
                window.toggleCrear();
            }
        };

        window.agregarGasto = () => {
            const desc = document.getElementById('gasto-nombre').value;
            const monto = parseFloat(document.getElementById('gasto-monto').value);

            if(desc && monto) {
                const newRef = push(ref(db, 'dia_actual/gastos'));
                set(newRef, { desc: desc, monto: monto });
                document.getElementById('gasto-nombre').value = '';
                document.getElementById('gasto-monto').value = '';
            }
        };

        // 5. CÃLCULOS Y UI
        function actualizarNumerosUI() {
            let totalVentas = 0;

            // Calcular ventas fijas
            menuFijo.forEach(item => {
                const cant = datosDia.ventas[item.id] || 0;
                const el = document.getElementById('cant_' + item.id);
                if(el) el.innerText = cant;
                totalVentas += cant * item.precio;
            });

            // Calcular ventas extras
            Object.keys(productosExtras).forEach(key => {
                const cant = datosDia.ventas[key] || 0;
                const el = document.getElementById('cant_' + key);
                if(el) el.innerText = cant;
                totalVentas += cant * productosExtras[key].precio;
            });

            // Calcular gastos
            let totalGastos = 0;
            if(datosDia.gastos) {
                Object.values(datosDia.gastos).forEach(g => totalGastos += g.monto);
            }

            // Actualizar Etiquetas
            const balance = totalVentas - totalGastos;
            document.getElementById('lbl-ventas').innerText = '$' + totalVentas.toFixed(2);
            document.getElementById('lbl-gastos').innerText = '-$' + totalGastos.toFixed(2);
            document.getElementById('lbl-balance').innerText = '$' + balance.toFixed(2);

            actualizarGrafica(totalVentas, totalGastos);
        }

        function renderGastos() {
            const ul = document.getElementById('lista-gastos-ul');
            ul.innerHTML = '';
            if(datosDia.gastos) {
                Object.values(datosDia.gastos).forEach(g => {
                    ul.innerHTML += `<li><span>${g.desc}</span> <span>-$${g.monto.toFixed(2)}</span></li>`;
                });
            }
        }

        // 6. GRÃFICA (Chart.js)
        function actualizarGrafica(ventas, gastos) {
            const ctx = document.getElementById('miGrafica').getContext('2d');
            
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ganancia Neta', 'Gastos/Costos'],
                    datasets: [{
                        data: [Math.max(0, ventas - gastos), gastos],
                        backgroundColor: ['#2ecc71', '#f39c12'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 7. CIERRE DE CAJA E HISTORIAL
        window.cerrarCaja = () => {
            const confirmacion = confirm("Â¿CERRAR CAJA?\n\nSe guardarÃ¡ el total en el historial y se pondrÃ¡n los contadores a CERO para maÃ±ana.");
            if(!confirmacion) return;

            const ventasVal = document.getElementById('lbl-ventas').innerText;
            const gastosVal = document.getElementById('lbl-gastos').innerText;
            const balanceVal = document.getElementById('lbl-balance').innerText;
            
            const fecha = new Date().toLocaleDateString('es-EC', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            const resumen = {
                fecha: fecha,
                total_ventas: ventasVal,
                total_gastos: gastosVal,
                balance_final: balanceVal
            };

            // Guardar en historial
            push(ref(db, 'historial'), resumen)
            .then(() => {
                // Borrar dÃ­a actual
                remove(ref(db, 'dia_actual'));
                alert("âœ… Caja cerrada y guardada en historial.");
            });
        };

        // Cargar Historial
        const historialRef = ref(db, 'historial');
        onValue(historialRef, (snapshot) => {
            const data = snapshot.val();
            const div = document.getElementById('container-historial');
            if(!data) {
                div.innerHTML = "No hay cierres guardados aÃºn.";
                return;
            }
            div.innerHTML = '';
            // Convertir objeto a array y reversar para ver lo ultimo primero
            const list = Object.values(data).reverse();
            
            list.forEach(item => {
                div.innerHTML += `
                <div class="historial-item">
                    <div class="fecha">${item.fecha}</div>
                    <div>Ventas: ${item.total_ventas} | Gastos: <span style="color:red">${item.total_gastos}</span></div>
                    <div style="font-weight:bold; margin-top:5px;">Ganancia: ${item.balance_final}</div>
                </div>`;
            });
        });

        // Tabs simples
        window.mostrarTab = (tabId) => {
            document.getElementById('tab-ventas').classList.add('hidden');
            document.getElementById('tab-gastos').classList.add('hidden');
            document.getElementById('tab-historial').classList.add('hidden');
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

    </script>
</body>
</html>
